<!DOCTYPE html>
<!--
 Copyright 2022 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>exporter.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>exporter.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2021, 2022 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Generated documentation is available at:
https://pkg.go.dev/github.com/RedHatInsights/insights-results-aggregator-exporter</p>

<p>Documentation in literate-programming-style is available at:
https://redhatinsights.github.io/insights-results-aggregator-exporter/packages/exporter.html</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bytes&#34;</div><div class="operator"></div>
	<div class="literal">&#34;flag&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;os&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/rs/zerolog&#34;</div><div class="operator"></div>
	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">versionMessage</div>         <div class="operator">=</div> <div class="literal">&#34;Insights Results Aggregator Cleaner version 1.0&#34;</div><div class="operator"></div>
	<div class="ident">authorsMessage</div>         <div class="operator">=</div> <div class="literal">&#34;Pavel Tisnovsky, Red Hat Inc.&#34;</div><div class="operator"></div>
	<div class="ident">operationFailedMessage</div> <div class="operator">=</div> <div class="literal">&#34;Operation failed&#34;</div><div class="operator"></div>
	<div class="ident">listOfTablesMsg</div>        <div class="operator">=</div> <div class="literal">&#34;List of tables&#34;</div><div class="operator"></div>
	<div class="ident">tableNameMsg</div>           <div class="operator">=</div> <div class="literal">&#34;Table name&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Exit codes</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusOK means that the tool finished with success</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusOK</div> <div class="operator">=</div> <div class="ident">iota</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusLoggingError is returned in case of any logging initialization
error</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusLoggingError</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusStorageError is returned in case of any consumer-related
error</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusStorageError</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusS3Error is returned in case of any error related with
S3/Minio connection</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusS3Error</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusConfigurationError is returned in case user provide wrong
configuration on command line or in configuration file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusConfigurationError</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ExitStatusIOError is returned in case of any I/O error (export data
into file failed etc.)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">ExitStatusIOError</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

<div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">configFileEnvVariableName</div> <div class="operator">=</div> <div class="literal">&#34;INSIGHTS_RESULTS_AGGREGATOR_EXPORTER_CONFIG_FILE&#34;</div><div class="operator"></div>
	<div class="ident">defaultConfigFileName</div>     <div class="operator">=</div> <div class="literal">&#34;config&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>output files or objects containing metadata</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">listOfTables</div>  <div class="operator">=</div> <div class="literal">&#34;_tables.csv&#34;</div><div class="operator"></div>
	<div class="ident">metadataTable</div> <div class="operator">=</div> <div class="literal">&#34;_metadata.csv&#34;</div><div class="operator"></div>
	<div class="ident">disabledRules</div> <div class="operator">=</div> <div class="literal">&#34;_disabled_rules.csv&#34;</div><div class="operator"></div>
	<div class="ident">logFile</div>       <div class="operator">=</div> <div class="literal">&#34;_logs.txt&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">readDisabledRulesInfoFailed</div>      <div class="operator">=</div> <div class="literal">&#34;Read disabled rules info failed&#34;</div><div class="operator"></div>
	<div class="ident">storeDisabledRulesIntoFileFailed</div> <div class="operator">=</div> <div class="literal">&#34;Store disabled rules into file failed&#34;</div><div class="operator"></div>
	<div class="ident">readingListOfTables</div>              <div class="operator">=</div> <div class="literal">&#34;Reading list of tables&#34;</div><div class="operator"></div>
	<div class="ident">exportingDisabledRules</div>           <div class="operator">=</div> <div class="literal">&#34;Exporting disabled rules&#34;</div><div class="operator"></div>
	<div class="ident">closingConnectionToStorage</div>       <div class="operator">=</div> <div class="literal">&#34;Closing connection to storage&#34;</div><div class="operator"></div>
	<div class="ident">exportingTables</div>                  <div class="operator">=</div> <div class="literal">&#34;Exporting tables&#34;</div><div class="operator"></div>
	<div class="ident">exportingTable</div>                   <div class="operator">=</div> <div class="literal">&#34;Exporting table&#34;</div><div class="operator"></div>
	<div class="ident">exportingMetadata</div>                <div class="operator">=</div> <div class="literal">&#34;Exporting metadata&#34;</div><div class="operator"></div>
	<div class="ident">unknownOutputType</div>                <div class="operator">=</div> <div class="literal">&#34;Unknown output type: %s&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>flags</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">s3Output</div>   <div class="operator">=</div> <div class="literal">&#34;S3&#34;</div><div class="operator"></div>
	<div class="ident">fileOutput</div> <div class="operator">=</div> <div class="literal">&#34;file&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>showVersion function displays version information.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">showVersion</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">versionMessage</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>showAuthors function displays information about authors.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">showAuthors</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">authorsMessage</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>showConfiguration function displays actual configuration.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">showConfiguration</div><div class="operator">(</div><div class="ident">config</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">storageConfig</div> <div class="operator">:=</div> <div class="ident">GetStorageConfiguration</div><div class="operator">(</div><div class="ident">config</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Driver&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;DB Name&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Username&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">)</div><div class="operator">.</div> <div class="comment">// password is omitted on purpose</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Host&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;DB Port&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Bool</div><div class="operator">(</div><div class="literal">&#34;LogSQLQueries&#34;</div><div class="operator">,</div> <div class="ident">storageConfig</div><div class="operator">.</div><div class="ident">LogSQLQueries</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Storage configuration&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">loggingConfig</div> <div class="operator">:=</div> <div class="ident">GetLoggingConfiguration</div><div class="operator">(</div><div class="ident">config</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Level&#34;</div><div class="operator">,</div> <div class="ident">loggingConfig</div><div class="operator">.</div><div class="ident">LogLevel</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Bool</div><div class="operator">(</div><div class="literal">&#34;Pretty colored debug logging&#34;</div><div class="operator">,</div> <div class="ident">loggingConfig</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Logging configuration&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">s3Configuration</div> <div class="operator">:=</div> <div class="ident">GetS3Configuration</div><div class="operator">(</div><div class="ident">config</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Type&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">Type</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;URL&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">EndpointURL</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Uint</div><div class="operator">(</div><div class="literal">&#34;S3 Port&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">EndpointPort</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;AccessKeyID&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">AccessKeyID</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;SecretAccessKey&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">SecretAccessKey</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Bool</div><div class="operator">(</div><div class="literal">&#34;Use SSL&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">UseSSL</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;Bucket name&#34;</div><div class="operator">,</div> <div class="ident">s3Configuration</div><div class="operator">.</div><div class="ident">Bucket</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;S3 configuration&#34;</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>performDataExport function exports all data into selected output</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">performDataExport</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">,</div> <div class="ident">cliFlags</div> <div class="ident">CliFlags</div><div class="operator">,</div> <div class="ident">operationLogger</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Retrieving connection to storage&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare the storage</p>
</td>
	<td class="code"><pre><code>	<div class="ident">storageConfiguration</div> <div class="operator">:=</div> <div class="ident">GetStorageConfiguration</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">storage</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">NewStorage</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">storageConfiguration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to retrieve connection to storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="ident">s3Output</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="ident">performDataExportToS3</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">,</div>
			<div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportMetadata</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportDisabledRules</div><div class="operator">,</div>
			<div class="ident">operationLogger</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="ident">fileOutput</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="ident">performDataExportToFiles</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">,</div> <div class="ident">storage</div><div class="operator">,</div>
			<div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportMetadata</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportDisabledRules</div><div class="operator">,</div>
			<div class="ident">operationLogger</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">unknownOutputType</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Wrong output type selected&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusConfigurationError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>performDataExportToS3 exports all tables and metadata info configured S3
bucket</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">performDataExportToS3</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">,</div>
	<div class="ident">storage</div> <div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">exportMetadata</div> <div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">ExportDisabledRules</div> <div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">operationLogger</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Exporting to S3&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readingListOfTables</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">context</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">NewS3Connection</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ExitStatusS3Error</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">tableNames</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ReadListOfTables</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;tables count&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">tableNames</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">listOfTablesMsg</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log into terminal</p>
</td>
	<td class="code"><pre><code>	<div class="ident">printTables</div><div class="operator">(</div><div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">bucket</div> <div class="operator">:=</div> <div class="ident">GetS3Configuration</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Bucket</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;bucket name&#34;</div><div class="operator">,</div> <div class="ident">bucket</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;S3 bucket to write to&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">exportMetadata</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingMetadata</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export list of all tables into S3</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storeTableNames</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div>
			<div class="ident">bucket</div><div class="operator">,</div> <div class="ident">listOfTables</div><div class="operator">,</div> <div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store table list to S3 failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export tables metadata into S3</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">StoreTableMetadataIntoS3</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div>
			<div class="ident">bucket</div><div class="operator">,</div> <div class="ident">metadataTable</div><div class="operator">,</div> <div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store tables metadata to S3 failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">ExportDisabledRules</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingDisabledRules</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export rules disabled by more users into CSV file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">disabledRulesInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ReadDisabledRules</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readDisabledRulesInfoFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readDisabledRulesInfoFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export list of disabled rules</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storeDisabledRulesIntoS3</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">bucket</div><div class="operator">,</div>
			<div class="ident">disabledRules</div><div class="operator">,</div> <div class="ident">disabledRulesInfo</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">storeDisabledRulesIntoFileFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">storeDisabledRulesIntoFileFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusIOError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingTables</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read content of all tables and perform export</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableNames</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingTable</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">StoreTable</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">bucket</div><div class="operator">,</div> <div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store table into S3 failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">closingConnectionToStorage</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we have finished, let's close the connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default exit value + no error</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>performDataExportToFiles exports all tables and metadata info files</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">performDataExportToFiles</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">,</div>
	<div class="ident">storage</div> <div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">exportMetadata</div> <div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">exportDisabledRules</div> <div class="ident">bool</div><div class="operator">,</div>
	<div class="ident">operationLogger</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Exporting to file&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readingListOfTables</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">tableNames</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ReadListOfTables</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;count&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">tableNames</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">listOfTablesMsg</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log into terminal</p>
</td>
	<td class="code"><pre><code>	<div class="ident">printTables</div><div class="operator">(</div><div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">exportMetadata</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingMetadata</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export list of all tables into CSV file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storeTableNamesIntoFile</div><div class="operator">(</div><div class="ident">listOfTables</div><div class="operator">,</div> <div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store table list to file failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export tables metadata into CSV file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">StoreTableMetadataIntoFile</div><div class="operator">(</div><div class="ident">metadataTable</div><div class="operator">,</div> <div class="ident">tableNames</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store tables metadata to file failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">exportDisabledRules</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingDisabledRules</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export rules disabled by more users into CSV file</p>
</td>
	<td class="code"><pre><code>		<div class="ident">disabledRulesInfo</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ReadDisabledRules</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readDisabledRulesInfoFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readDisabledRulesInfoFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>export list of disabled rules</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storeDisabledRulesIntoFile</div><div class="operator">(</div><div class="ident">disabledRules</div><div class="operator">,</div> <div class="ident">disabledRulesInfo</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">storeDisabledRulesIntoFileFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">storeDisabledRulesIntoFileFailed</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusIOError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingTables</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read content of all tables and perform export</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableNames</div> <div class="operator">{</div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Msg</div><div class="operator">(</div><div class="ident">exportingTable</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">StoreTableIntoFile</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">const</div> <div class="ident">msg</div> <div class="operator">=</div> <div class="literal">&#34;Store table into file failed&#34;</div><div class="operator"></div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="ident">tableNameMsg</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
				<div class="ident">Msg</div><div class="operator">(</div><div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">closingConnectionToStorage</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>we have finished, let's close the connection to database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="ident">operationLogger</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">operationFailedMessage</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusStorageError</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default exit value + no error</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">printTables</div><div class="operator">(</div><div class="ident">tableNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">TableName</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">tableNames</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;#&#34;</div><div class="operator">,</div> <div class="ident">i</div><div class="operator">&#43;</div><div class="literal">1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;table&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Table in database&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>checkS3Connection checks if connection to S3 is possible</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">checkS3Connection</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Checking connection to S3&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">context</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">NewS3Connection</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ExitStatusS3Error</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">exists</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">s3BucketExists</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">GetS3Configuration</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Bucket</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">ExitStatusS3Error</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="operator">!</div><div class="ident">exists</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not find expected bucket&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div> <div class="keyword">else</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Bucket has been found&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Connection to S3 seems to be ok&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">storeOpertionLogIntoS3</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">,</div>
	<div class="ident">buffer</div> <div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">context</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">NewS3Connection</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">bucketName</div> <div class="operator">:=</div> <div class="ident">GetS3Configuration</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Bucket</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">storeBufferToS3</div><div class="operator">(</div><div class="ident">context</div><div class="operator">,</div> <div class="ident">minioClient</div><div class="operator">,</div> <div class="ident">bucketName</div><div class="operator">,</div> <div class="ident">logFile</div><div class="operator">,</div> <div class="ident">buffer</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>doSelectedOperation function perform operation selected on command line.
When no operation is specified, the Notification writer service is started
instead.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">doSelectedOperation</div><div class="operator">(</div><div class="ident">configuration</div> <div class="operator">*</div><div class="ident">ConfigStruct</div><div class="operator">,</div> <div class="ident">cliFlags</div> <div class="ident">CliFlags</div><div class="operator">,</div>
	<div class="ident">operationLogger</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">switch</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowVersion</div><div class="operator">:</div>
		<div class="ident">showVersion</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowAuthors</div><div class="operator">:</div>
		<div class="ident">showAuthors</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowConfiguration</div><div class="operator">:</div>
		<div class="ident">showConfiguration</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
	<div class="keyword">case</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">CheckS3Connection</div><div class="operator">:</div>
		<div class="keyword">return</div> <div class="ident">checkS3Connection</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default operation - data export</p>
</td>
	<td class="code"><pre><code>		<div class="keyword">return</div> <div class="ident">performDataExport</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">,</div> <div class="ident">operationLogger</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>this can not happen: return ExitStatusOK, nil</p>
</td>
	<td class="code"><pre><code><div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">parseFlags</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">cliFlags</div> <div class="ident">CliFlags</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>define and parse all command line options</p>
</td>
	<td class="code"><pre><code>	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowVersion</div><div class="operator">,</div> <div class="literal">&#34;version&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;show version&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowAuthors</div><div class="operator">,</div> <div class="literal">&#34;authors&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;show authors&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ShowConfiguration</div><div class="operator">,</div> <div class="literal">&#34;show-configuration&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;show configuration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">PrintSummaryTable</div><div class="operator">,</div> <div class="literal">&#34;summary&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;print summary table after export&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div><div class="operator">,</div> <div class="literal">&#34;output&#34;</div><div class="operator">,</div> <div class="literal">&#34;S3&#34;</div><div class="operator">,</div> <div class="literal">&#34;output to: file, S3&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportMetadata</div><div class="operator">,</div> <div class="literal">&#34;metadata&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;export metadata&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportDisabledRules</div><div class="operator">,</div> <div class="literal">&#34;disabled-by-more-users&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;export rules disabled by more users&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">CheckS3Connection</div><div class="operator">,</div> <div class="literal">&#34;check-s3-connection&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;check S3 connection and exit&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">BoolVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportLog</div><div class="operator">,</div> <div class="literal">&#34;export-log&#34;</div><div class="operator">,</div> <div class="ident">false</div><div class="operator">,</div> <div class="literal">&#34;export log&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>parse all command line flags</p>
</td>
	<td class="code"><pre><code>	<div class="ident">flag</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DummyWriter satisfies Writer interface, but with noop write</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DummyWriter</div> <div class="keyword">struct</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Write method satisfies noop io.Write</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">w</div> <div class="ident">DummyWriter</div><div class="operator">)</div> <div class="ident">Write</div><div class="operator">(</div><div class="ident">p</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">byte</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">n</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="literal">0</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>createOperationLog function constructs operation log instance</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">createOperationLog</div><div class="operator">(</div><div class="ident">cliFlags</div> <div class="ident">CliFlags</div><div class="operator">,</div> <div class="ident">buffer</div> <div class="operator">*</div><div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">zerolog</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">dummyLogger</div> <div class="operator">:=</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">DummyWriter</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div><div class="operator">.</div><div class="ident">With</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportLog</div> <div class="operator">{</div>
		<div class="keyword">switch</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div> <div class="operator">{</div>
		<div class="keyword">case</div> <div class="ident">s3Output</div><div class="operator">:</div>
			<div class="ident">memoryLogger</div> <div class="operator">:=</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">buffer</div><div class="operator">)</div><div class="operator">.</div><div class="ident">With</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">memoryLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Memory logger initialized&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">memoryLogger</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="keyword">case</div> <div class="ident">fileOutput</div><div class="operator">:</div>
			<div class="ident">logFile</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Create</div><div class="operator">(</div><div class="ident">logFile</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="keyword">return</div> <div class="ident">dummyLogger</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="ident">fileLogger</div> <div class="operator">:=</div> <div class="ident">zerolog</div><div class="operator">.</div><div class="ident">New</div><div class="operator">(</div><div class="ident">logFile</div><div class="operator">)</div><div class="operator">.</div><div class="ident">With</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Logger</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">fileLogger</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;File logger initialized&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">fileLogger</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
		<div class="keyword">default</div><div class="operator">:</div>
			<div class="keyword">return</div> <div class="ident">dummyLogger</div><div class="operator">,</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="ident">unknownOutputType</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">dummyLogger</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>

<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">mainWithStatusCode</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">int</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Started&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>parse all command line flags</p>
</td>
	<td class="code"><pre><code>	<div class="ident">cliFlags</div> <div class="operator">:=</div> <div class="ident">parseFlags</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>config has exactly the same structure as *.toml file</p>
</td>
	<td class="code"><pre><code>	<div class="ident">config</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">LoadConfiguration</div><div class="operator">(</div><div class="ident">configFileEnvVariableName</div><div class="operator">,</div> <div class="ident">defaultConfigFileName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Load configuration&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">loggingCloser</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">InitLogging</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">config</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Init logging&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusLoggingError</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="ident">loggingCloser</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">buffer</div> <div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator"></div>
	<div class="ident">operationLogger</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">createOperationLog</div><div class="operator">(</div><div class="ident">cliFlags</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">buffer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Create operation log&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">ExitStatusIOError</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>perform selected operation</p>
</td>
	<td class="code"><pre><code>	<div class="ident">exitStatus</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">doSelectedOperation</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">config</div><div class="operator">,</div> <div class="ident">cliFlags</div><div class="operator">,</div> <div class="ident">operationLogger</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Do selected operation&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">exitStatus</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">ExportLog</div> <div class="operator">&amp;&amp;</div> <div class="ident">cliFlags</div><div class="operator">.</div><div class="ident">Output</div> <div class="operator">==</div> <div class="ident">s3Output</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storeOpertionLogIntoS3</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">config</div><div class="operator">,</div> <div class="ident">buffer</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Storing log into S3 failed&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">ExitStatusS3Error</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Debug</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Finished&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">ExitStatusOK</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">main</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">exitStatus</div> <div class="operator">:=</div> <div class="ident">mainWithStatusCode</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">os</div><div class="operator">.</div><div class="ident">Exit</div><div class="operator">(</div><div class="ident">exitStatus</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
