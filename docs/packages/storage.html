<!DOCTYPE html>
<!--
 Copyright 2022 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>storage.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>storage.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2021, 2022 Red Hat, Inc.

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

<div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;bytes&#34;</div><div class="operator"></div>
	<div class="literal">&#34;context&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/csv&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;io&#34;</div><div class="operator"></div>

	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>

	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div>           <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/mattn/go-sqlite3&#34;</div> <div class="operator"></div><div class="comment">// SQLite database driver</div>

	<div class="literal">&#34;github.com/rs/zerolog/log&#34;</div><div class="operator"></div>

	<div class="literal">&#34;github.com/minio/minio-go/v7&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Driver types</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverSQLite3 shows that db driver is sqlite</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverSQLite3</div> <div class="ident">DBDriver</div> <div class="operator">=</div> <div class="ident">iota</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverPostgres shows that db driver is postgres</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverPostgres</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBDriverGeneral general sql(used for mock now)</p>
</td>
	<td class="code"><pre><code>	<div class="ident">DBDriverGeneral</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Error messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">canNotConnectToDataStorageMessage</div> <div class="operator">=</div> <div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator"></div>
	<div class="ident">unableToCloseDBRowsHandle</div>         <div class="operator">=</div> <div class="literal">&#34;Unable to close the DB rows handle&#34;</div><div class="operator"></div>
	<div class="ident">sqlStatementExecutionError</div>        <div class="operator">=</div> <div class="literal">&#34;SQL statement execution error&#34;</div><div class="operator"></div>
	<div class="ident">unableToRetrieveColumnTypes</div>       <div class="operator">=</div> <div class="literal">&#34;Unable to retrieve column types&#34;</div><div class="operator"></div>
	<div class="ident">readTableContentFailed</div>            <div class="operator">=</div> <div class="literal">&#34;Read table content failed&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>SQL statements</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Select all public tables from open database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">selectListOfTables</div> <div class="operator">=</div> <div class="literal">`
           SELECT tablename
             FROM pg_catalog.pg_tables
            WHERE schemaname != &#39;information_schema&#39;
              AND schemaname != &#39;pg_catalog&#39;;
   `</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Storage represents an interface to almost any database or storage system</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Storage</div> <div class="keyword">interface</div> <div class="operator">{</div>
	<div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>

	<div class="ident">ReadListOfTables</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">TableName</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">ReadTable</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">string</div><div class="operator">)</div> <div class="ident">error</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>DBStorage is an implementation of Storage interface that use selected SQL like database
like SQLite, PostgreSQL, MariaDB, RDS etc. That implementation is based on the standard
sql package. It is possible to configure connection via Configuration structure.
SQLQueriesLog is log for sql queries, default is nil which means nothing is logged</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">DBStorage</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">connection</div>   <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator"></div>
	<div class="ident">dbDriverType</div> <div class="ident">DBDriver</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewStorage function creates and initializes a new instance of Storage interface</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewStorage</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">DBStorage</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Initializing connection to storage&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">driverType</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unsupported driver&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;driver&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;datasource&#34;</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator">.</div>
		<div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Making connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare connection</p>
</td>
	<td class="code"><pre><code>	<div class="ident">connection</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not connect to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Connection to storage established&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div><div class="operator">,</div> <div class="ident">driverType</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>NewFromConnection function creates and initializes a new instance of Storage interface from prepared connection</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">NewFromConnection</div><div class="operator">(</div><div class="ident">connection</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">dbDriverType</div> <div class="ident">DBDriver</div><div class="operator">)</div> <div class="operator">*</div><div class="ident">DBStorage</div> <div class="operator">{</div>
	<div class="keyword">return</div> <div class="operator">&amp;</div><div class="ident">DBStorage</div><div class="operator">{</div>
		<div class="ident">connection</div><div class="operator">:</div>   <div class="ident">connection</div><div class="operator">,</div>
		<div class="ident">dbDriverType</div><div class="operator">:</div> <div class="ident">dbDriverType</div><div class="operator">,</div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initAndGetDriver initializes driver(with logs if logSQLQueries is true),
checks if it's supported and returns driver type, driver name, dataSource and error</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initAndGetDriver</div><div class="operator">(</div><div class="ident">configuration</div> <div class="ident">StorageConfiguration</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">driverType</div> <div class="ident">DBDriver</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">,</div> <div class="ident">dataSource</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">err</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>var driver sql_driver.Driver</p>
</td>
	<td class="code"><pre><code>	<div class="ident">driverName</div> <div class="operator">=</div> <div class="ident">configuration</div><div class="operator">.</div><div class="ident">Driver</div><div class="operator"></div>

	<div class="keyword">switch</div> <div class="ident">driverName</div> <div class="operator">{</div>
	<div class="keyword">case</div> <div class="literal">&#34;sqlite3&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">DBDriverSQLite3</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;sqlite3.SQLiteDriver{}
dataSource = configuration.SQLiteDataSource</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">case</div> <div class="literal">&#34;postgres&#34;</div><div class="operator">:</div>
		<div class="ident">driverType</div> <div class="operator">=</div> <div class="ident">DBDriverPostgres</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>driver = &amp;pq.Driver{}</p>
</td>
	<td class="code"><pre><code>		<div class="ident">dataSource</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div>
			<div class="literal">&#34;postgresql://%v:%v@%v:%v/%v?%v&#34;</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGUsername</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPassword</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGHost</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGPort</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGDBName</div><div class="operator">,</div>
			<div class="ident">configuration</div><div class="operator">.</div><div class="ident">PGParams</div><div class="operator">,</div>
		<div class="operator">)</div><div class="operator"></div>
	<div class="keyword">default</div><div class="operator">:</div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Errorf</div><div class="operator">(</div><div class="literal">&#34;driver %v is not supported&#34;</div><div class="operator">,</div> <div class="ident">driverName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Close method closes the connection to database. Needs to be called at the
end of application lifecycle.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Closing connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Can not close connection to data storage&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadListOfTables method reads names of all public tables stored in opened
database.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadListOfTables</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">TableName</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>slice to make list of tables</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">tableList</div> <div class="operator">=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">TableName</div><div class="operator">,</div> <div class="literal">0</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">selectListOfTables</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">tableList</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read all table names</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="keyword">if</div> <div class="ident">closeErr</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">closeErr</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
				<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">closeErr</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
			<div class="operator">}</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">tableList</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">tableList</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">tableList</div><div class="operator">,</div> <div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">tableList</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>logColumnTypes is helper function to print column names and types for
selected table.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">logColumnTypes</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator">,</div> <div class="ident">columnTypes</div> <div class="operator">[</div><div class="operator">]</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">ColumnType</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;table columns&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;columns&#34;</div><div class="operator">,</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">columnTypes</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;table metadata&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">columnType</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">columnTypes</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;name&#34;</div><div class="operator">,</div> <div class="ident">columnType</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;type&#34;</div><div class="operator">,</div> <div class="ident">columnType</div><div class="operator">.</div><div class="ident">DatabaseTypeName</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator">.</div>
			<div class="ident">Int</div><div class="operator">(</div><div class="literal">&#34;column&#34;</div><div class="operator">,</div> <div class="ident">i</div><div class="operator">&#43;</div><div class="literal">1</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;column type&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fillInScanArgs prepares arguments for the Scan method to retrieve row from
selected table.</p>

<p>Based on:
https://stackoverflow.com/questions/42774467/how-to-convert-sql-rows-to-typed-json-in-golang#60386531</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">fillInScanArgs</div><div class="operator">(</div><div class="ident">columnTypes</div> <div class="operator">[</div><div class="operator">]</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">ColumnType</div><div class="operator">)</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div> <div class="operator">{</div>
	<div class="ident">count</div> <div class="operator">:=</div> <div class="ident">len</div><div class="operator">(</div><div class="ident">columnTypes</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>data structure to scan one row</p>
</td>
	<td class="code"><pre><code>	<div class="ident">scanArgs</div> <div class="operator">:=</div> <div class="ident">make</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">count</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">v</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">columnTypes</div> <div class="operator">{</div>
		<div class="keyword">switch</div> <div class="ident">v</div><div class="operator">.</div><div class="ident">DatabaseTypeName</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="keyword">case</div> <div class="literal">&#34;VARCHAR&#34;</div><div class="operator">,</div> <div class="literal">&#34;TEXT&#34;</div><div class="operator">,</div> <div class="literal">&#34;UUID&#34;</div><div class="operator">,</div> <div class="literal">&#34;TIMESTAMP&#34;</div><div class="operator">:</div>
			<div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullString</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">break</div><div class="operator"></div>
		<div class="keyword">case</div> <div class="literal">&#34;BOOL&#34;</div><div class="operator">:</div>
			<div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullBool</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">break</div><div class="operator"></div>
		<div class="keyword">case</div> <div class="literal">&#34;INT4&#34;</div><div class="operator">:</div>
			<div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullInt64</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">break</div><div class="operator"></div>
		<div class="keyword">default</div><div class="operator">:</div>
			<div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullString</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">scanArgs</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fillInMasterData fills the structure by row data read from database from
selected table.</p>

<p>Based on:
https://stackoverflow.com/questions/42774467/how-to-convert-sql-rows-to-typed-json-in-golang#60386531</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">fillInMasterData</div><div class="operator">(</div><div class="ident">columnTypes</div> <div class="operator">[</div><div class="operator">]</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">ColumnType</div><div class="operator">,</div> <div class="ident">scanArgs</div> <div class="operator">[</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">)</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div> <div class="operator">{</div>
	<div class="ident">masterData</div> <div class="operator">:=</div> <div class="keyword">map</div><div class="operator">[</div><div class="ident">string</div><div class="operator">]</div><div class="keyword">interface</div><div class="operator">{</div><div class="operator">}</div><div class="operator">{</div><div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fill-in the data structure by row data</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">i</div><div class="operator">,</div> <div class="ident">v</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">columnTypes</div> <div class="operator">{</div>

		<div class="keyword">if</div> <div class="ident">z</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullBool</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">z</div><div class="operator">.</div><div class="ident">Bool</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">z</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullString</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">z</div><div class="operator">.</div><div class="ident">String</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">z</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullInt64</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">z</div><div class="operator">.</div><div class="ident">Int64</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">z</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullFloat64</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">z</div><div class="operator">.</div><div class="ident">Float64</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">z</div><div class="operator">,</div> <div class="ident">ok</div> <div class="operator">:=</div> <div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator">)</div><div class="operator">.</div><div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">NullInt32</div><div class="operator">)</div><div class="operator">;</div> <div class="ident">ok</div> <div class="operator">{</div>
			<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">z</div><div class="operator">.</div><div class="ident">Int32</div><div class="operator"></div>
			<div class="keyword">continue</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">masterData</div><div class="operator">[</div><div class="ident">v</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">]</div> <div class="operator">=</div> <div class="ident">scanArgs</div><div class="operator">[</div><div class="ident">i</div><div class="operator">]</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">masterData</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">select1FromTable</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>it is not possible to use parameter for table name or a key
disable &quot;G201 (CWE-89): SQL string formatting (Confidence: HIGH, Severity: MEDIUM)&quot;</p>

<h1>nosec G201</h1>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;SELECT * FROM %s LIMIT 1&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">selectAllFromTable</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator">)</div> <div class="ident">string</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>it is not possible to use parameter for table name or a key
disable &quot;G201 (CWE-89): SQL string formatting (Confidence: HIGH, Severity: MEDIUM)&quot;</p>

<h1>nosec G201</h1>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;SELECT * FROM %s&#34;</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>ReadTable method reads the whole content of selected table.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">ReadTable</div><div class="operator">(</div><div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">M</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="ident">selectAllFromTable</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Info</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Str</div><div class="operator">(</div><div class="literal">&#34;SQL statement&#34;</div><div class="operator">,</div> <div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Performing&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">sqlStatementExecutionError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to retrieve column types</p>
</td>
	<td class="code"><pre><code>	<div class="ident">columnTypes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">ColumnTypes</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToRetrieveColumnTypes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">logColumnTypes</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">,</div> <div class="ident">columnTypes</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare data structure to hold raw values</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">finalRows</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">M</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>read table row by row</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">for</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Next</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare arguments for the Scan method to retrieve row from
selected table.</p>
</td>
	<td class="code"><pre><code>		<div class="ident">scanArgs</div> <div class="operator">:=</div> <div class="ident">fillInScanArgs</div><div class="operator">(</div><div class="ident">columnTypes</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>do the actual scan of row read from database</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Scan</div><div class="operator">(</div><div class="ident">scanArgs</div><div class="operator">...</div><div class="operator">)</div><div class="operator"></div>

		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Unable to scan row&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>it is now needed to check each element of values for nil
then to use type introspection and type assertion to be
able to fetch the column into a typed variable if needed</p>
</td>
	<td class="code"><pre><code>		<div class="ident">masterData</div> <div class="operator">:=</div> <div class="ident">fillInMasterData</div><div class="operator">(</div><div class="ident">columnTypes</div><div class="operator">,</div> <div class="ident">scanArgs</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>TODO: make the export part there
println(masterData)</p>
</td>
	<td class="code"><pre><code>		<div class="ident">finalRows</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">finalRows</div><div class="operator">,</div> <div class="ident">masterData</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">finalRows</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>StoreTable function stores specified table into S3/Minio
TODO: Really needs refactoring!!!
TODO: refactor retrieving column types info function</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="operator">(</div><div class="ident">storage</div> <div class="ident">DBStorage</div><div class="operator">)</div> <div class="ident">StoreTable</div><div class="operator">(</div><div class="ident">ctx</div> <div class="ident">context</div><div class="operator">.</div><div class="ident">Context</div><div class="operator">,</div>
	<div class="ident">minioClient</div> <div class="operator">*</div><div class="ident">minio</div><div class="operator">.</div><div class="ident">Client</div><div class="operator">,</div> <div class="ident">bucketName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">tableName</div> <div class="ident">TableName</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="ident">sqlStatement</div> <div class="operator">:=</div> <div class="ident">select1FromTable</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">rows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">connection</div><div class="operator">.</div><div class="ident">Query</div><div class="operator">(</div><div class="ident">sqlStatement</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">sqlStatementExecutionError</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to retrieve column types</p>
</td>
	<td class="code"><pre><code>	<div class="ident">columnTypes</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">ColumnTypes</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToRetrieveColumnTypes</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">rows</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">unableToCloseDBRowsHandle</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">logColumnTypes</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">,</div> <div class="ident">columnTypes</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">buffer</div> <div class="operator">:=</div> <div class="ident">new</div><div class="operator">(</div><div class="ident">bytes</div><div class="operator">.</div><div class="ident">Buffer</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">writer</div> <div class="operator">:=</div> <div class="ident">csv</div><div class="operator">.</div><div class="ident">NewWriter</div><div class="operator">(</div><div class="ident">buffer</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">colNames</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">columnType</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">columnTypes</div> <div class="operator">{</div>
		<div class="ident">colNames</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">colNames</div><div class="operator">,</div> <div class="ident">columnType</div><div class="operator">.</div><div class="ident">Name</div><div class="operator">(</div><div class="operator">)</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">writer</div><div class="operator">.</div><div class="ident">Write</div><div class="operator">(</div><div class="ident">colNames</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Write column names to CSV&#34;</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>now we know column types, time to perform export</p>
</td>
	<td class="code"><pre><code>	<div class="ident">finalRows</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">ReadTable</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="ident">readTableContentFailed</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">finalRow</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">finalRows</div> <div class="operator">{</div>
		<div class="keyword">var</div> <div class="ident">columns</div> <div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator"></div>
		<div class="keyword">for</div> <div class="ident">_</div><div class="operator">,</div> <div class="ident">colName</div> <div class="operator">:=</div> <div class="keyword">range</div> <div class="ident">colNames</div> <div class="operator">{</div>
			<div class="ident">value</div> <div class="operator">:=</div> <div class="ident">finalRow</div><div class="operator">[</div><div class="ident">colName</div><div class="operator">]</div><div class="operator"></div>
			<div class="ident">str</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;%v&#34;</div><div class="operator">,</div> <div class="ident">value</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">columns</div> <div class="operator">=</div> <div class="ident">append</div><div class="operator">(</div><div class="ident">columns</div><div class="operator">,</div> <div class="ident">str</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">writer</div><div class="operator">.</div><div class="ident">Write</div><div class="operator">(</div><div class="ident">columns</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Error</div><div class="operator">(</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Err</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator">.</div><div class="ident">Msg</div><div class="operator">(</div><div class="literal">&#34;Write one row to CSV&#34;</div><div class="operator">)</div><div class="operator"></div>
			<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="ident">writer</div><div class="operator">.</div><div class="ident">Flush</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">reader</div> <div class="operator">:=</div> <div class="ident">io</div><div class="operator">.</div><div class="ident">Reader</div><div class="operator">(</div><div class="ident">buffer</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">options</div> <div class="operator">:=</div> <div class="ident">minio</div><div class="operator">.</div><div class="ident">PutObjectOptions</div><div class="operator">{</div><div class="ident">ContentType</div><div class="operator">:</div> <div class="literal">&#34;text/csv&#34;</div><div class="operator">}</div><div class="operator"></div>
	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">minioClient</div><div class="operator">.</div><div class="ident">PutObject</div><div class="operator">(</div><div class="ident">ctx</div><div class="operator">,</div> <div class="ident">bucketName</div><div class="operator">,</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">tableName</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">reader</div><div class="operator">,</div> <div class="operator">-</div><div class="literal">1</div><div class="operator">,</div> <div class="ident">options</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
